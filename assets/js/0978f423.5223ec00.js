"use strict";(self.webpackChunksite=self.webpackChunksite||[]).push([[173],{3905:(e,t,o)=>{o.d(t,{Zo:()=>s,kt:()=>v});var a=o(7294);function n(e,t,o){return t in e?Object.defineProperty(e,t,{value:o,enumerable:!0,configurable:!0,writable:!0}):e[t]=o,e}function r(e,t){var o=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),o.push.apply(o,a)}return o}function u(e){for(var t=1;t<arguments.length;t++){var o=null!=arguments[t]?arguments[t]:{};t%2?r(Object(o),!0).forEach((function(t){n(e,t,o[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(o)):r(Object(o)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(o,t))}))}return e}function l(e,t){if(null==e)return{};var o,a,n=function(e,t){if(null==e)return{};var o,a,n={},r=Object.keys(e);for(a=0;a<r.length;a++)o=r[a],t.indexOf(o)>=0||(n[o]=e[o]);return n}(e,t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(a=0;a<r.length;a++)o=r[a],t.indexOf(o)>=0||Object.prototype.propertyIsEnumerable.call(e,o)&&(n[o]=e[o])}return n}var d=a.createContext({}),i=function(e){var t=a.useContext(d),o=t;return e&&(o="function"==typeof e?e(t):u(u({},t),e)),o},s=function(e){var t=i(e.components);return a.createElement(d.Provider,{value:t},e.children)},c="mdxType",m={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},p=a.forwardRef((function(e,t){var o=e.components,n=e.mdxType,r=e.originalType,d=e.parentName,s=l(e,["components","mdxType","originalType","parentName"]),c=i(o),p=n,v=c["".concat(d,".").concat(p)]||c[p]||m[p]||r;return o?a.createElement(v,u(u({ref:t},s),{},{components:o})):a.createElement(v,u({ref:t},s))}));function v(e,t){var o=arguments,n=t&&t.mdxType;if("string"==typeof e||n){var r=o.length,u=new Array(r);u[0]=p;var l={};for(var d in t)hasOwnProperty.call(t,d)&&(l[d]=t[d]);l.originalType=e,l[c]="string"==typeof e?e:n,u[1]=l;for(var i=2;i<r;i++)u[i]=o[i];return a.createElement.apply(null,u)}return a.createElement.apply(null,o)}p.displayName="MDXCreateElement"},4224:(e,t,o)=>{o.r(t),o.d(t,{assets:()=>d,contentTitle:()=>u,default:()=>m,frontMatter:()=>r,metadata:()=>l,toc:()=>i});var a=o(7462),n=(o(7294),o(3905));const r={title:"SQL DSL"},u=void 0,l={unversionedId:"what-is/dsl",id:"what-is/dsl",title:"SQL DSL",description:"Yes, yes, yes. We all know SQL DSLs terrible.",source:"@site/docs/what-is/dsl.md",sourceDirName:"what-is",slug:"/what-is/dsl",permalink:"/typo/docs/what-is/dsl",draft:!1,tags:[],version:"current",frontMatter:{title:"SQL DSL"},sidebar:"tutorialSidebar",previous:{title:"Generated code for relations",permalink:"/typo/docs/what-is/relations"},next:{title:"Getting started",permalink:"/typo/docs/setup"}},d={},i=[{value:"getting started",id:"getting-started",level:2},{value:"select DSL",id:"select-dsl",level:2},{value:"update DSL",id:"update-dsl",level:2},{value:"delete DSL",id:"delete-dsl",level:2},{value:"usage example",id:"usage-example",level:2},{value:"imports for examples below",id:"imports-for-examples-below",level:2},{value:"inserts",id:"inserts",level:2},{value:"query dsl:",id:"query-dsl",level:2}],s={toc:i},c="wrapper";function m(e){let{components:t,...o}=e;return(0,n.kt)(c,(0,a.Z)({},s,o,{components:t,mdxType:"MDXLayout"}),(0,n.kt)("p",null,"Yes, yes, yes. We all know SQL DSLs terrible.\nBut there are so many times you just need to grab some data, and it's ",(0,n.kt)("em",{parentName:"p"},"so")," convenient to do it with a DSL."),(0,n.kt)("p",null,"That's why typo ships an ",(0,n.kt)("em",{parentName:"p"},"optional")," (but strongly recommended) SQL DSL.\nIt's optional because people seem to have strong feelings about the concept of SQL DSLs. "),(0,n.kt)("h2",{id:"getting-started"},"getting started"),(0,n.kt)("p",null,"See ",(0,n.kt)("a",{parentName:"p",href:"/typo/docs/setup"},"Getting started")," for some information about how to set up the DSL."),(0,n.kt)("h2",{id:"select-dsl"},"select DSL"),(0,n.kt)("p",null,"some features"),(0,n.kt)("ul",null,(0,n.kt)("li",{parentName:"ul"},"type-safe"),(0,n.kt)("li",{parentName:"ul"},"generates not-too-terrible SQL"),(0,n.kt)("li",{parentName:"ul"},"arbitrarily deep joins"),(0,n.kt)("li",{parentName:"ul"},"order by"),(0,n.kt)("li",{parentName:"ul"},"expresses a rich set of predicates (sql operators, functions, string functions, comparisons, etc)"),(0,n.kt)("li",{parentName:"ul"},"for instance string and array functions (!, ",(0,n.kt)("a",{parentName:"li",href:"/typo/docs/type-safety/arrays"},"arrays")," are incredibly difficult to use through JDBC)"),(0,n.kt)("li",{parentName:"ul"},"set of operators and functions are extendable by user"),(0,n.kt)("li",{parentName:"ul"},"works both when backed by ",(0,n.kt)("a",{parentName:"li",href:"/typo/docs/other-features/testing-with-stubs"},"in-memory stubs")," and by Postgres")),(0,n.kt)("video",{width:"100%",controls:!0,autoplay:"autoplay",src:"https://user-images.githubusercontent.com/247937/257662719-2a295f48-7cd2-4c49-b043-90bc8511de67.mp4"}),(0,n.kt)("h2",{id:"update-dsl"},"update DSL"),(0,n.kt)("p",null,"Can express batch updates, where you ",(0,n.kt)("inlineCode",{parentName:"p"},"set")," arbitrary number of columns with an arbitrary number of (implicitly ",(0,n.kt)("inlineCode",{parentName:"p"},"AND"),"ed) predicates."),(0,n.kt)("p",null,"Column values can be computed from the original value in the column or from the entire row, as seen below"),(0,n.kt)("video",{width:"100%",controls:!0,autoplay:"autoplay",src:"https://user-images.githubusercontent.com/247937/257148737-7b32df2c-af54-4397-85d3-eab863179d78.mp4"}),(0,n.kt)("h2",{id:"delete-dsl"},"delete DSL"),(0,n.kt)("p",null,"There is also a ",(0,n.kt)("inlineCode",{parentName:"p"},"delete")," DSL, similar to ",(0,n.kt)("inlineCode",{parentName:"p"},"select")," and ",(0,n.kt)("inlineCode",{parentName:"p"},"update"),". It has no video yet, unfortunately."),(0,n.kt)("h2",{id:"usage-example"},"usage example"),(0,n.kt)("h2",{id:"imports-for-examples-below"},"imports for examples below"),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-scala"},"import java.time.LocalDateTime\nimport java.util.UUID\nimport adventureworks.customtypes.{Defaulted, TypoLocalDateTime, TypoShort, TypoXml}\nimport adventureworks.production.product.*\nimport adventureworks.production.productcategory.*\nimport adventureworks.production.productmodel.*\nimport adventureworks.production.productsubcategory.*\nimport adventureworks.production.unitmeasure.*\nimport adventureworks.public.{Flag, Name}\nimport adventureworks.withConnection\n\nval productRepo: ProductRepo = ProductRepoImpl\nval projectModelRepo: ProductmodelRepo = ProductmodelRepoImpl\nval unitmeasureRepo: UnitmeasureRepo = UnitmeasureRepoImpl\nval productcategoryRepo: ProductcategoryRepo = ProductcategoryRepoImpl\nval productsubcategoryRepo: ProductsubcategoryRepo = ProductsubcategoryRepoImpl\n")),(0,n.kt)("h2",{id:"inserts"},"inserts"),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-scala"},'val unitmeasure = unitmeasureRepo.insert(\n  UnitmeasureRowUnsaved(\n    unitmeasurecode = UnitmeasureId("kgg"),\n    name = Name("name")\n  )\n)\n// unitmeasure: UnitmeasureRow = UnitmeasureRow(\n//   unitmeasurecode = UnitmeasureId(value = "kgg"),\n//   name = Name(value = "name"),\n//   modifieddate = TypoLocalDateTime(value = 2023-09-01T14:44:08.044823)\n// )\nval productCategory = productcategoryRepo.insert(\n  new ProductcategoryRowUnsaved(\n    name = Name("name")\n  )\n)\n// productCategory: ProductcategoryRow = ProductcategoryRow(\n//   productcategoryid = ProductcategoryId(value = 543),\n//   name = Name(value = "name"),\n//   rowguid = 3e072dda-48c5-11ee-8d6d-0242ac160002,\n//   modifieddate = TypoLocalDateTime(value = 2023-09-01T14:44:08.044823)\n// )\n\nval productSubcategory = productsubcategoryRepo.insert(\n  ProductsubcategoryRowUnsaved(\n    productcategoryid = productCategory.productcategoryid,\n    name = Name("name")\n  )\n)\n// productSubcategory: ProductsubcategoryRow = ProductsubcategoryRow(\n//   productsubcategoryid = ProductsubcategoryId(value = 543),\n//   productcategoryid = ProductcategoryId(value = 543),\n//   name = Name(value = "name"),\n//   rowguid = 3e0a1fb8-48c5-11ee-8d6d-0242ac160002,\n//   modifieddate = TypoLocalDateTime(value = 2023-09-01T14:44:08.044823)\n// )\nval productmodel = projectModelRepo.insert(\n  ProductmodelRowUnsaved(\n    name = Name("name"),\n    catalogdescription = Some(new TypoXml("<xml/>")),\n    instructions = Some(new TypoXml("<instructions/>"))\n  )\n)\n// productmodel: ProductmodelRow = ProductmodelRow(\n//   productmodelid = ProductmodelId(value = 693),\n//   name = Name(value = "name"),\n//   catalogdescription = Some(value = TypoXml(value = "<xml/>")),\n//   instructions = Some(value = TypoXml(value = "<instructions/>")),\n//   rowguid = 3e0f6630-48c5-11ee-8d6d-0242ac160002,\n//   modifieddate = TypoLocalDateTime(value = 2023-09-01T14:44:08.044823)\n// )\nval unsaved1 = ProductRowUnsaved(\n  name = Name("name"),\n  productnumber = "productnumber",\n  color = Some("color"),\n  safetystocklevel = TypoShort(16),\n  reorderpoint = TypoShort(18),\n  standardcost = BigDecimal(20),\n  listprice = BigDecimal(22),\n  size = Some("size"),\n  sizeunitmeasurecode = Some(unitmeasure.unitmeasurecode),\n  weightunitmeasurecode = Some(unitmeasure.unitmeasurecode),\n  weight = Some(1.00),\n  daystomanufacture = 26,\n  productline = Some("T "),\n  `class` = Some("H "),\n  style = Some("W "),\n  productsubcategoryid = Some(productSubcategory.productsubcategoryid),\n  productmodelid = Some(productmodel.productmodelid),\n  sellstartdate = TypoLocalDateTime(LocalDateTime.now().plusDays(1)),\n  sellenddate = Some(TypoLocalDateTime(LocalDateTime.now().plusDays(10))),\n  discontinueddate = Some(TypoLocalDateTime(LocalDateTime.now().plusDays(100))),\n  productid = Defaulted.UseDefault,\n  makeflag = Defaulted.Provided(Flag(true)),\n  finishedgoodsflag = Defaulted.Provided(Flag(true)),\n  rowguid = Defaulted.Provided(UUID.randomUUID()),\n  modifieddate = Defaulted.Provided(TypoLocalDateTime.now)\n)\n// unsaved1: ProductRowUnsaved = ProductRowUnsaved(\n//   name = Name(value = "name"),\n//   productnumber = "productnumber",\n//   color = Some(value = "color"),\n//   safetystocklevel = TypoShort(value = 16),\n//   reorderpoint = TypoShort(value = 18),\n//   standardcost = 20,\n//   listprice = 22,\n//   size = Some(value = "size"),\n//   sizeunitmeasurecode = Some(value = UnitmeasureId(value = "kgg")),\n//   weightunitmeasurecode = Some(value = UnitmeasureId(value = "kgg")),\n//   weight = Some(value = 1.0),\n//   daystomanufacture = 26,\n//   productline = Some(value = "T "),\n//   class = Some(value = "H "),\n//   style = Some(value = "W "),\n//   productsubcategoryid = Some(value = ProductsubcategoryId(value = 543)),\n//   productmodelid = Some(value = ProductmodelId(value = 693)),\n//   sellstartdate = TypoLocalDateTime(value = 2023-09-02T14:44:08.209108),\n//   sellenddate = Some(\n//     value = TypoLocalDateTime(value = 2023-09-11T14:44:08.209432)\n//   ),\n//   discontinueddate = Some(\n//     value = TypoLocalDateTime(value = 2023-12-10T14:44:08.209442)\n//   ),\n//   productid = UseDefault,\n//   makeflag = Provided(value = Flag(value = true)),\n//   finishedgoodsflag = Provided(value = Flag(value = true)),\n//   rowguid = Provided(value = ff137d2d-0025-463c-829a-c04905d7cd69),\n//   modifieddate = Provided(\n//     value = TypoLocalDateTime(value = 2023-09-01T14:44:08.210627)\n//   )\n// )\n\nval saved1 = productRepo.insert(unsaved1)\n// saved1: ProductRow = ProductRow(\n//   productid = ProductId(value = 543),\n//   name = Name(value = "name"),\n//   productnumber = "productnumber",\n//   makeflag = Flag(value = true),\n//   finishedgoodsflag = Flag(value = true),\n//   color = Some(value = "color"),\n//   safetystocklevel = TypoShort(value = 16),\n//   reorderpoint = TypoShort(value = 18),\n//   standardcost = 20,\n//   listprice = 22,\n//   size = Some(value = "size"),\n//   sizeunitmeasurecode = Some(value = UnitmeasureId(value = "kgg")),\n//   weightunitmeasurecode = Some(value = UnitmeasureId(value = "kgg")),\n//   weight = Some(value = 1.00),\n//   daystomanufacture = 26,\n//   productline = Some(value = "T "),\n//   class = Some(value = "H "),\n//   style = Some(value = "W "),\n//   productsubcategoryid = Some(value = ProductsubcategoryId(value = 543)),\n//   productmodelid = Some(value = ProductmodelId(value = 693)),\n//   sellstartdate = TypoLocalDateTime(value = 2023-09-02T14:44:08.209108),\n//   sellenddate = Some(\n//     value = TypoLocalDateTime(value = 2023-09-11T14:44:08.209432)\n//   ),\n//   discontinueddate = Some(\n//     value = TypoLocalDateTime(value = 2023-12-10T14:44:08.209442)\n//   ),\n//   rowguid = ff137d2d-0025-463c-829a-c04905d7cd69,\n//   modifieddate = TypoLocalDateTime(value = 2023-09-01T14:44:08.210627)\n// )\n')),(0,n.kt)("h2",{id:"query-dsl"},"query dsl:"),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-scala"},'productRepo.select\n  .where(_.`class` === "H ")\n  .where(x => x.daystomanufacture > 25 or x.daystomanufacture <= 0)\n  .where(x => x.productline === "foo")\n  .join(unitmeasureRepo.select.where(_.name.like("name%")))\n  .on { case (p, um) => p.sizeunitmeasurecode === um.unitmeasurecode }\n  .join(projectModelRepo.select)\n  .leftOn { case ((product, _), productModel) => product.productmodelid === productModel.productmodelid }\n  .where { case ((product, _), productModel) => product.productmodelid === productModel(_.productmodelid) }\n  .orderBy { case ((product, _), _) => product.productmodelid.asc }\n  .orderBy { case ((_, _), productModel) => productModel(_.name).desc.withNullsFirst }\n  .toList\n// res1: List[Tuple2[Tuple2[ProductRow, UnitmeasureRow], Option[ProductmodelRow]]] = List(\n//   (\n//     (\n//       ProductRow(\n//         productid = ProductId(value = 543),\n//         name = Name(value = "name"),\n//         productnumber = "productnumber",\n//         makeflag = Flag(value = true),\n//         finishedgoodsflag = Flag(value = true),\n//         color = Some(value = "color"),\n//         safetystocklevel = TypoShort(value = 16),\n//         reorderpoint = TypoShort(value = 18),\n//         standardcost = 20,\n//         listprice = 22,\n//         size = Some(value = "size"),\n//         sizeunitmeasurecode = Some(value = UnitmeasureId(value = "kgg")),\n//         weightunitmeasurecode = Some(value = UnitmeasureId(value = "kgg")),\n//         weight = Some(value = 1.00),\n//         daystomanufacture = 26,\n//         productline = Some(value = "T "),\n//         class = Some(value = "H "),\n//         style = Some(value = "W "),\n//         productsubcategoryid = Some(value = ProductsubcategoryId(value = 543)),\n//         productmodelid = Some(value = ProductmodelId(value = 693)),\n//         sellstartdate = TypoLocalDateTime(value = 2023-09-02T14:44:08.209108),\n//         sellenddate = Some(\n//           value = TypoLocalDateTime(value = 2023-09-11T14:44:08.209432)\n//         ),\n//         discontinueddate = Some(\n//           value = TypoLocalDateTime(value = 2023-12-10T14:44:08.209442)\n//         ),\n//         rowguid = ff137d2d-0025-463c-829a-c04905d7cd69,\n//         modifieddate = TypoLocalDateTime(value = 2023-09-01T14:44:08.210627)\n//       ),\n//       UnitmeasureRow(\n//         unitmeasurecode = UnitmeasureId(value = "kgg"),\n//         name = Name(value = "name"),\n//         modifieddate = TypoLocalDateTime(value = 2023-09-01T14:44:08.044823)\n//       )\n//     ),\n//     Some(\n//       value = ProductmodelRow(\n//         productmodelid = ProductmodelId(value = 693),\n//         name = Name(value = "name"),\n//         catalogdescription = Some(value = TypoXml(value = "<xml/>")),\n//         instructions = Some(value = TypoXml(value = "<instructions/>")),\n//         rowguid = 3e0f6630-48c5-11ee-8d6d-0242ac160002,\n//         modifieddate = TypoLocalDateTime(value = 2023-09-01T14:44:08.044823)\n//       )\n// ...\n')))}m.isMDXComponent=!0}}]);